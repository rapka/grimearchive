extends layout

block content

	.upload.content 
		.upload-title.blue
			p Edit

		div.upload-inputs
			form(id="_form", name="upload", action="/upload", method="post", enctype='multipart/form-data')
				div.upload-label
					| Title
				if mix.title
					input(type="text", name="title" value='#{mix.title}')
				else 
					input(type="text", name="title")
				div.upload-label
					| DJ
				if mix.dj
					input(type="text", name="dj" value='#{mix.dj}')
				else
					input(type="text", name="dj")
				br
				div.upload-label
					| MCs
				if mix.mcs.length > 0
					input(type="text", name="mcs" value='#{mix.mcs}')
				else
					input(type="text", name="mcs")
				div.upload-label
					| Crews
				if mix.crews.length > 0
					input(type="text", name="crews" value='#{mix.crews}')
				else
					input(type="text", name="crews")
				div.upload-label
					| Radio Station / Rave: 
				if mix.station
					input(type="text", name="station" value='#{mix.station}')
				else
					input(type="text", name="station")
				br
				div.upload-label
					| Air Date
				if mix.day
					input(type="text", name="day" placeholder="day" class="date" value='#{mix.day}')
				else
					input(type="text", name="day" placeholder="day" class="date")
				if mix.month
					input(type="text", name="month" placeholder="month" class="date" value='#{mix.month}')
				else
					input(type="text", name="month" placeholder="month" class="date")
				if mix.year
					input(type="text", name="year" placeholder="year" class="date" value='#{mix.year}')
				else
					input(type="text", name="year" placeholder="year" class="date")
				br
				div.upload-divider
				br
				div.upload-label
					| Additional comments
				textarea(name="description" cols="40" rows="5")
					| #{mix.description}
				br
				div.upload-label
					| Hidden
				if mix.hidden
					input(type="checkbox" name="hidden" value="hidden" checked)
				else 
					input(type="checkbox" name="hidden" value="hidden")
				br
				div.upload-divider
				div.upload-label
					| MP3 Options
				
				div.option-container
					div.mp3-option
						| Use title as album title?
					div.squaredOne
						input(type="checkbox" value="None" id="squaredOne2" name="albumtitle")
						label(for="squaredOne2")
					div.album-tooltip.tooltip-button
						|   (?)
					div.tooltip.album-tooltip-text
						br
						| If checked, the title of the mix will also be used as the tag for the album title, 
						| otherwise the title 'Grime Archive' will be used.
				input(type="hidden", name="edit" value="#{mix.url}")
				input(type='submit', value='Update mix', id='_submit')
				script(src='https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js')
				script(type='text/javascript').
					function uploadFile() {
						console.log("uploading");
						//evt.preventDefault();
						var form = document.getElementById('_form');
						var fd = new FormData(form);

						var file = document.getElementById('_file');
					
						var xhr = new XMLHttpRequest();

						xhr.upload.addEventListener("progress", function (evt) {
								if (evt.lengthComputable) {
									var percentage = Math.floor((evt.loaded / evt.total) * 100);
									$('#_submit').prop('value', percentage + '%');
								}
							}, false);
						xhr.onreadystatechange = function() {
							var result;
							console.log(xhr);

							if (xhr.readyState == 4) {
								var split = xhr.responseText.split("/")[2];
								setInterval(function() { 
									$.get("upload/" + split, function (data) {
										if (parseInt(data) > 0) {
												window.location = xhr.responseText; 
											}
										}); 
									}, 200);
								
							}
						};
						xhr.open('post', '/upload', true);
						
						xhr.send(fd);	

					}

		

